<!doctype html>
<html lang="zh-Hans">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Couple Finance — 共同理财工具</title>
<style>
  :root{
    --bg:#f7f7f9; --card:#ffffff; --accent:#d88ea8; --muted:#666; --glass: rgba(216,142,168,0.08);
    --radius:12px; --pad:14px; --maxw:980px;
  }
  *{box-sizing:border-box}
  body{font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial; background:var(--bg); margin:20px; color:#222; display:flex; justify-content:center}
  .wrap{width:100%; max-width:var(--maxw)}
  header{display:flex;align-items:center;gap:14px;margin-bottom:12px}
  h1{font-size:1.2rem;margin:0;color:var(--accent)}
  .subtitle{color:var(--muted); font-size:0.9rem}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
  @media(max-width:900px){ .grid{grid-template-columns:1fr} }

  .card{background:var(--card);border-radius:var(--radius);padding:var(--pad);box-shadow:0 6px 18px var(--glass)}
  label{display:block;font-size:0.9rem;color:var(--muted);margin-top:8px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #ece7ea;font-size:0.95rem}
  button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
  .muted{color:var(--muted);font-size:0.9rem}
  .row{display:flex;gap:8px}
  .col{flex:1}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #f1eef1;text-align:left;font-size:0.95rem}
  th{color:var(--muted);font-weight:600}
  .small{font-size:0.85rem;color:var(--muted)}
  .progress{height:14px;background:#f3ecef;border-radius:999px;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,var(--accent),#ea9fb8);width:0%}
  .goal-item{display:flex;align-items:center;gap:10px;margin-top:8px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .search{display:flex;gap:8px;align-items:center}
  .kbd{background:#fafafa;border:1px solid #eee;padding:6px 8px;border-radius:8px;font-size:0.85rem}
  .pill{background:#fff7fb;border:1px solid #f1e5eb;padding:6px 8px;border-radius:999px;font-size:0.85rem;color:var(--muted)}
  .muted-2{color:#9b98a0}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Couple Finance · 共同理财</h1>
        <div class="subtitle">Minimal · Professional · Multi-goal savings · Monthly reports / 简约专业 · 多目标存款 · 月度报表</div>
      </div>
      <div style="margin-left:auto" class="small muted">Local only • Export/Import sync available · 本地存储 · 支持导出/导入同步</div>
    </header>

    <div class="grid">
      <!-- LEFT: Main content -->
      <div>
        <!-- Add transaction -->
        <div class="card" id="txCard">
          <strong>New Record / 新增记录</strong>
          <label>Description / 描述</label>
          <input id="desc" placeholder="e.g. Dinner, Groceries / 晚餐、超市">
          <div class="row">
            <div class="col">
              <label>Amount (MYR) / 金额</label>
              <input id="amt" type="number" step="0.01" placeholder="100.00">
            </div>
            <div class="col">
              <label>Date / 日期</label>
              <input id="date" type="date">
            </div>
          </div>
          <label>Category / 类别（e.g. groceries, transport, savings）</label>
          <input id="cat" placeholder="savings / food / travel">
          <div style="margin-top:8px" class="small muted">If you mark Category = <strong>savings</strong>, the amount will count toward goals. / 若类别为 <strong>savings</strong>，该笔金额计入存款目标。</div>
          <div class="actions" style="margin-top:10px">
            <button id="addBtn">Add / 添加</button>
            <button id="addQuickGoal" style="background:#fff;border:1px solid #f1e5eb;color:var(--accent)">Quick Save 10 / 快速存 10</button>
            <button id="clearForm" style="background:#fff;border:1px solid #f1e5eb;color:var(--muted)">Clear / 清除</button>
          </div>
        </div>

        <!-- Transactions list & search -->
        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>History / 历史记录</strong>
            <div class="search">
              <input id="q" placeholder="Search description, category / 搜索描述、类别" style="padding:6px 8px;border-radius:8px;border:1px solid #eee">
              <select id="filterMonth" style="padding:6px;border-radius:8px;border:1px solid #eee">
                <option value="all">All months / 所有月份</option>
              </select>
            </div>
          </div>

          <table id="txTable" style="margin-top:10px">
            <thead><tr><th>Date</th><th>Desc</th><th>Category</th><th>Amount</th><th></th></tr></thead>
            <tbody></tbody>
          </table>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <button id="exportCsv" style="background:#fff;border:1px solid #ece7ea;color:var(--muted)">Export CSV / 导出 CSV</button>
            <button id="importCsvBtn" style="background:#fff;border:1px solid #ece7ea;color:var(--muted)">Import CSV / 导入 CSV</button>
            <input id="importFile" type="file" accept=".csv,.json" style="display:none">
            <div class="small muted-2" style="margin-left:auto">Tip: export & share the file to sync between devices. / 小提示：导出并分享文件实现设备间同步。</div>
          </div>
        </div>

        <!-- Monthly Report -->
        <div class="card" style="margin-top:12px">
          <strong>Monthly Report / 月度报表</strong>
          <div class="small muted" id="reportSummary">No data yet / 暂无数据</div>
          <div id="reportDetails" style="margin-top:10px"></div>
        </div>

      </div>

      <!-- RIGHT: Sidebar -->
      <aside>
        <!-- Summary -->
        <div class="card">
          <strong>Summary / 汇总</strong>
          <div style="margin-top:8px">
            <div class="small">Total spent / 总花费</div>
            <div style="font-size:1.4rem;font-weight:700" id="totSpan">RM 0.00</div>
            <div class="small muted" id="since">—</div>
          </div>
          <hr style="border:none;border-top:1px solid #f1eef1;margin:10px 0">
          <div>
            <div class="small">Joint savings (counted) / 计入目标的存款</div>
            <div style="font-weight:700" id="savedSpan">RM 0.00</div>
          </div>
        </div>

        <!-- Goals -->
        <div class="card" style="margin-top:12px">
          <strong>Savings Goals / 存钱目标</strong>
          <label style="margin-top:8px">Add goal 名称 (e.g. Trip) & amount / 名称 & 金额</label>
          <div class="row">
            <input id="goalName" placeholder="Trip / 旅游">
            <input id="goalAmt" placeholder="Amount / 金额" type="number" style="width:140px">
          </div>
          <div style="margin-top:8px" class="actions">
            <button id="addGoal">Add Goal / 新增目标</button>
            <button id="clearGoals" style="background:#fff;border:1px solid #f1e5eb;color:var(--muted)">Clear Goals</button>
          </div>

          <div id="goalsArea" style="margin-top:10px"></div>
        </div>

        <!-- Sync / Export Import -->
        <div class="card" style="margin-top:12px">
          <strong>Sync · Share / 同步 · 分享</strong>
          <div class="small" style="margin-top:8px">Quick sync: copy the JSON and paste it on partner's device (Import JSON). / 复制 JSON 给对方并在对方设备导入。</div>
          <div style="margin-top:8px">
            <button id="exportJson" style="width:100%">Export JSON / 导出 JSON</button>
            <button id="importJson" style="width:100%;margin-top:8px;background:#fff;border:1px solid #ece7ea;color:var(--muted)">Import JSON / 导入 JSON</button>
            <textarea id="jsonArea" placeholder="Exported JSON appears here / 导出的 JSON 会在此显示" style="height:90px;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #eee;width:100%"></textarea>
            <div style="margin-top:8px" class="small muted">Export + Paste into partner's JSON box to sync. / 导出后粘贴到对方的 JSON 区完成同步。</div>
          </div>
        </div>

      </aside>
    </div>

    <footer style="margin-top:12px" class="small muted">Built for you — professional & simple. / 为你打造 · 专业且简单</footer>
  </div>

<script>
/*
  Couple Finance — single-file app
  - localStorage keys: cf_tx, cf_goals
  - record structure: {date, desc, amt, cat}
  - goals: [{id,name,amt}]
  - savings counted when cat.toLowerCase() === 'savings'
  - simple sync/export: JSON export/import (full data)
*/

const LS_TX = "cf_tx_v1";
const LS_GOALS = "cf_goals_v1";
const dateInput = document.getElementById('date');
dateInput.valueAsDate = new Date();

function loadTx(){ return JSON.parse(localStorage.getItem(LS_TX) || '[]'); }
function saveTx(arr){ localStorage.setItem(LS_TX, JSON.stringify(arr)); }
function loadGoals(){ return JSON.parse(localStorage.getItem(LS_GOALS) || '[]'); }
function saveGoals(a){ localStorage.setItem(LS_GOALS, JSON.stringify(a)); }

function formatMoney(v){ return 'RM ' + Number(v||0).toFixed(2); }
function formatDate(d){
  const dt = new Date(d);
  if(isNaN(dt)) return d;
  return dt.toLocaleDateString();
}

/* render transactions */
function renderTx(filterQ='', monthFilter='all'){
  const data = loadTx();
  const tbody = document.querySelector('#txTable tbody');
  tbody.innerHTML = '';
  data.forEach((r, idx)=>{
    if(filterQ){
      const q = filterQ.toLowerCase();
      if(!(r.desc.toLowerCase().includes(q) || (r.cat||'').toLowerCase().includes(q))) return;
    }
    if(monthFilter !== 'all'){
      const m = new Date(r.date).toISOString().slice(0,7);
      if(m !== monthFilter) return;
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${formatDate(r.date)}</td><td>${r.desc}</td><td>${r.cat||''}</td><td>${formatMoney(r.amt)}</td><td><button data-i="${idx}" class="delBtn">Del</button></td>`;
    tbody.appendChild(tr);
  });
  // attach deletes (note: indexes correspond to full array; deletion uses index attr)
  tbody.querySelectorAll('.delBtn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const i = Number(e.target.dataset.i);
      if(confirm('Delete this record? 删除记录?')){
        const arr = loadTx();
        arr.splice(i,1);
        saveTx(arr);
        renderAll();
      }
    });
  });
}

/* summary & totals */
function computeSummary(){
  const data = loadTx();
  let total=0, saved=0;
  let earliest = null;
  data.forEach(r=>{
    total += Number(r.amt||0);
    if((r.cat||'').toLowerCase() === 'savings') saved += Number(r.amt||0);
    const d = new Date(r.date);
    if(!earliest || d < earliest) earliest = d;
  });
  document.getElementById('totSpan').textContent = formatMoney(total);
  document.getElementById('savedSpan').textContent = formatMoney(saved);
  document.getElementById('since').textContent = earliest ? ('Since ' + earliest.toLocaleDateString()) : '—';
  return {total,saved};
}

/* goals render */
function renderGoals(){
  const goals = loadGoals();
  const area = document.getElementById('goalsArea');
  area.innerHTML = '';
  const saved = computeSummary().saved;
  // compute contribution per goal by simple priority: total saved is shown; we don't auto-assign amounts to goals.
  goals.forEach((g, idx)=>{
    const percent = Math.min(1, (g.collected || 0) / g.amt);
    const wrapper = document.createElement('div');
    wrapper.className = 'goal-item';
    wrapper.innerHTML = `
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${g.name}</strong><div class="small muted">${formatMoney(g.amt)}</div></div>
          <div class="small">${Math.round(percent*100)}%</div>
        </div>
        <div class="progress" style="margin-top:8px"><div class="bar" style="width:${percent*100}%"></div></div>
      </div>
      <div style="min-width:80px;text-align:right">
        <button data-i="${idx}" class="goalEdit" style="background:#fff;border:1px solid #f1e5eb;color:var(--muted)">Edit</button>
        <button data-i="${idx}" class="goalDel" style="background:#fff;border:1px solid #f1e5eb;color:var(--muted);margin-top:6px">Del</button>
      </div>
    `;
    area.appendChild(wrapper);
  });
  // attach handlers
  area.querySelectorAll('.goalDel').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const i = Number(e.target.dataset.i);
      if(confirm('Delete goal? 删除目标?')){
        const g = loadGoals(); g.splice(i,1); saveGoals(g); renderAll();
      }
    });
  });
  area.querySelectorAll('.goalEdit').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const i = Number(e.target.dataset.i);
      const g = loadGoals()[i];
      const nn = prompt('Edit name', g.name);
      if(nn===null) return;
      const na = prompt('Edit amount', g.amt);
      if(na===null) return;
      const arr = loadGoals(); arr[i].name = nn; arr[i].amt = Number(na); saveGoals(arr); renderAll();
    });
  });
}

/* report (monthly) */
function renderReport(){
  const data = loadTx();
  if(!data.length){ document.getElementById('reportSummary').textContent='No data yet / 暂无数据'; document.getElementById('reportDetails').innerHTML=''; return; }
  // group by YYYY-MM
  const byMonth = {};
  data.forEach(r=>{
    const m = new Date(r.date).toISOString().slice(0,7);
    if(!byMonth[m]) byMonth[m] = [];
    byMonth[m].push(r);
  });
  const months = Object.keys(byMonth).sort().reverse();
  // build simple summary
  const s = months.map(m=>{
    const arr = byMonth[m];
    let tot=0, sav=0;
    const byCat = {};
    arr.forEach(r=>{
      tot += Number(r.amt||0);
      if((r.cat||'').toLowerCase()==='savings') sav += Number(r.amt||0);
      const c = r.cat || 'uncategorized';
      byCat[c] = (byCat[c]||0) + Number(r.amt||0);
    });
    const cats = Object.entries(byCat).map(([c,v])=>`${c}: ${formatMoney(v)}`).join(' · ');
    return `<div style="margin-bottom:8px"><strong>${m}</strong> — Total ${formatMoney(tot)} · Savings ${formatMoney(sav)}<div class="small muted" style="margin-top:6px">${cats}</div></div>`;
  }).join('');
  document.getElementById('reportSummary').textContent = `Months: ${months.length} · Latest: ${months[0] || '—'}`;
  document.getElementById('reportDetails').innerHTML = s;
}

/* month filter populate */
function populateMonthFilter(){
  const sel = document.getElementById('filterMonth');
  sel.innerHTML = '<option value="all">All months / 所有月份</option>';
  const months = Array.from(new Set(loadTx().map(t=> new Date(t.date).toISOString().slice(0,7) ))).sort().reverse();
  months.forEach(m=>{
    const opt = document.createElement('option'); opt.value=m; opt.textContent = m; sel.appendChild(opt);
  });
}

/* render everything */
function renderAll(){
  populateMonthFilter();
  renderTx(document.getElementById('q').value || '', document.getElementById('filterMonth').value || 'all');
  computeSummary();
  renderGoals();
  renderReport();
}

/* events */
document.getElementById('addBtn').addEventListener('click', ()=>{
  const desc = document.getElementById('desc').value.trim() || '—';
  const amt = Number(document.getElementById('amt').value) || 0;
  const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
  const cat = document.getElementById('cat').value.trim() || '';
  if(amt <= 0){ alert('Enter positive amount / 输入正数'); return; }
  const arr = loadTx();
  arr.unshift({date, desc, amt, cat});
  saveTx(arr);
  // clear small inputs
  document.getElementById('desc').value=''; document.getElementById('amt').value=''; document.getElementById('cat').value='';
  renderAll();
});

document.getElementById('addQuickGoal').addEventListener('click', ()=>{
  // quick save: create a savings record of 10
  const arr = loadTx();
  const date = new Date().toISOString().slice(0,10);
  arr.unshift({date, desc:'Quick save', amt:10, cat:'savings'});
  saveTx(arr);
  renderAll();
});

document.getElementById('clearForm').addEventListener('click', ()=>{ document.getElementById('desc').value=''; document.getElementById('amt').value=''; document.getElementById('cat').value=''; });

document.getElementById('q').addEventListener('input', ()=>{
  renderTx(document.getElementById('q').value.trim(), document.getElementById('filterMonth').value);
});

document.getElementById('filterMonth').addEventListener('change', ()=>{ renderTx(document.getElementById('q').value.trim(), document.getElementById('filterMonth').value); });

document.getElementById('exportCsv').addEventListener('click', ()=>{
  const data = loadTx();
  if(!data.length){ alert('No data to export / 无数据导出'); return; }
  const rows = [['date','desc','cat','amt']];
  data.forEach(r=> rows.push([r.date, r.desc.replace(/"/g,'""'), r.cat, r.amt]));
  const csv = rows.map(r=> r.map(c=> `"${String(c)}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'couple_finance.csv'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('importCsvBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    const text = ev.target.result;
    try{
      if(f.name.toLowerCase().endsWith('.json')){
        const j = JSON.parse(text);
        if(Array.isArray(j.tx)) { localStorage.setItem(LS_TX, JSON.stringify(j.tx)); }
        if(Array.isArray(j.goals)) { localStorage.setItem(LS_GOALS, JSON.stringify(j.goals)); }
        alert('Imported JSON');
        renderAll();
      } else {
        // parse CSV minimal
        const lines = text.split(/\r?\n/).filter(Boolean);
        const data = [];
        for(let i=1;i<lines.length;i++){
          const parts = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=> s.replace(/^"|"$/g,''));
          if(parts.length>=4) data.push({date:parts[0], desc:parts[1], cat:parts[2], amt: Number(parts[3])});
        }
        localStorage.setItem(LS_TX, JSON.stringify(data));
        alert('CSV imported (replaced transactions)');
        renderAll();
      }
    }catch(err){ alert('Import failed: ' + err.message); }
  };
  reader.readAsText(f);
});

/* export/import JSON (simple sync) */
document.getElementById('exportJson').addEventListener('click', ()=>{
  const payload = {tx: loadTx(), goals: loadGoals(), exportedAt: new Date().toISOString()};
  const txt = JSON.stringify(payload, null, 2);
  document.getElementById('jsonArea').value = txt;
  // also trigger file download
  const blob = new Blob([txt], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='couple_finance_export.json'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('importJson').addEventListener('click', ()=>{
  const txt = document.getElementById('jsonArea').value.trim();
  if(!txt){ alert('Paste exported JSON here / 将导出的 JSON 粘贴到此处'); return; }
  try{
    const p = JSON.parse(txt);
    if(Array.isArray(p.tx)) localStorage.setItem(LS_TX, JSON.stringify(p.tx));
    if(Array.isArray(p.goals)) localStorage.setItem(LS_GOALS, JSON.stringify(p.goals));
    alert('Imported JSON');
    renderAll();
  }catch(e){ alert('Invalid JSON'); }
});

/* goals add / clear */
document.getElementById('addGoal').addEventListener('click', ()=>{
  const n = document.getElementById('goalName').value.trim() || 'Goal';
  const a = Number(document.getElementById('goalAmt').value) || 0;
  if(a <= 0){ alert('Enter goal amount / 输入目标金额'); return; }
  const g = loadGoals(); g.push({id:Date.now(), name:n, amt:a, collected:0}); saveGoals(g);
  document.getElementById('goalName').value=''; document.getElementById('goalAmt').value='';
  renderAll();
});
document.getElementById('clearGoals').addEventListener('click', ()=>{ if(confirm('Clear all goals?')){ localStorage.removeItem(LS_GOALS); renderAll(); } });

/* initial render */
renderAll();

</script>
</body>
</html>
